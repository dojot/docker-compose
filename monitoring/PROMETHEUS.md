# Prometheus services Deploy - Docker compose

## About

This readme contains the steps for deploying the ``Prometheus`` monitoring application and the ``Grafana`` which is used to visualize and analyze how metrics generated by prometheus.

## Disclaimer

As the inclusion of services (Prometheus and grafana) is under development, some services are currently not being monitored. The following describes the services already implemented.

## Node-Exporter

Node is an exporter used to get metrics from the host itself. In other words, the metrics obtained by prometheus are directly related to the hardware and operating system.

We are initially analyzing the following information:

* Total time the service is running;
* Quantities of cores that the host CPU has;
* Total amount of host RAM memory;
* Total amount of containers;
* Percentage of storage used on the host;
* Percentage of host memory usage;
* Amount of host SWAP memory;
* Network traffic (Sent and Received);
* Percentage of host CPU usage;
* Total Memory, Free Memory and Avaliable Memory;
* Amount of memory for I/O processes;
* Used space of available disks.


## CAdvisor

CAdvisor is an export developed by google providing metrics regarding resource usage and performance characteristics of running containers.

Following the same line of reasoning presented for Node-Exporter, below are the metrics we are analyzing:

* Current status of the container: Running, Stopped and Paused;
* Network traffic received by container;
* Network traffic sent by container;
* Percentage of memory usage per container;
* Percentage of CPU usage per container;
* RSS Memory Usage per Container (Among the memory allocated to the process, how much is being used by RAM memory)
* Use of memory RAM per container;
* RAM memory available for each container;
* Memory limit established for each container;

## How to use the service???

As we use the docker, it is natural that we use its metrics, to set the Docker daemon as a Prometheus target, you need to specify the metrics-address. We tell prometheus the path via ``daemon.json``, which is located in ``/etc/docker/daemon.json`` in linux environments.

If the file is empty, paste the following:

``
{
  "metrics-addr" : "0.0.0.0:9323",
  "experimental" : true
}
``

If the file is not empty, add these two keys, making sure the resulting file is a valid JSON. Be careful that all lines end with a comma ( ,) except the last line.

Since we are running prometheus on localhost, in case we try to use the docker as localhost as well. Prometheus would understand that the metrics would be inside the service itself (prometheus) and then try to access port ``9323`` inside the promethues container. To prevent this from happening we will use the default port **172.17.0.1** of the **bridge** docker ``docker0``.

Before running make sure that the port of ``docker0`` is really the default with the command:

```
ip addr show docker0
```

The output will be similar to the one shown below, the *IP* will normally appear on the third line after the term ``inet``:
```
docker0: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc noqueue state DOWN group default 
    link/ether 02:42:a3:bf:97:21 brd ff:ff:ff:ff:ff:ff
    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0
       valid_lft forever preferred_lft forever
    inet6 fe80::42:a3ff:febf:9721/64 scope link 
       valid_lft forever preferred_lft forever
```

If the IP is different, **COPIE**.
## Changing prometheus.yml

If the port is not the default one, we need to change in the configuration file of the jobs that prometheus will analyze, the port of the docker service. Then change in the file [prometheus.yml](prometheus/prometheus.yml) the docker job, to the copied IP.

Example job **docker**:

```
  - job_name: 'docker'
    static_configs:
      - targets: 
          - <IP_DOCKER0>:9323
```

## Starting services

As we've already done the configuration, we can start the service:


```
cd monitoring

docker-compose -f docker-compose-monitoring.yml up -d
```

When the process is complete, we can check whether the services have been started:

*   [Metrics Docker](http://localhost:9323/metrics).

*   [Metrics Prometheus](http://localhost:9090/metrics).

Visually, it is possible to check if everything is "UP" by [Targets Prometheus](http://localhost:9090/targets).

## Viewing metrics in grafana

As the service is declared in [Docker Compose Monitoring](docker-compose-monitoring.yml), it has already been instantiated. Then just access the service at the URL http://localhost:3000.

**USER**=``admin``

**SENHA**=``admin``

[Grafana](http://localhost:3000)


## Graphana Configuration

If there is a need to change or analyze the configuration files, you will find them in [Grafana Configuration Files](grafana/).

In the indicated folder, there are all dashboards (in json files), configuration files of the dashboards themselves and the data source.

## Viewing data

As the data and data source have already been imported automatically you will be able to verify the data. Since the dashboard of:

* **System Metrics** refers to exporting Node-Exporter;
* **Docker Metrics** refers to the CAdvisor exporter;
* **Overview** has the main panels of each dashboard.